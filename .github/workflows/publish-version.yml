name: Publish Version

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  publish-version:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Bump patch + sync version files
        run: |
          set -e
          if [ ! -f VERSION ]; then
            echo "VERSION file not found." >&2
            exit 1
          fi

          python3 - <<'PY'
          import re
          from pathlib import Path

          version_path = Path("VERSION")
          version = version_path.read_text().strip()
          m = re.fullmatch(r"(\\d+)\\.(\\d+)\\.(\\d+)\\.(\\d{1,3})", version)
          if not m:
            raise SystemExit(f"VERSION format invalid: {version!r}")

          major, minor, patch, _build = map(int, m.groups())
          patch += 1
          new_version = f"{major}.{minor}.{patch}.00"

          version_path.write_text(new_version + "\\n")
          Path("deploy/VERSION").write_text(new_version + "\\n")

          csproj_path = Path("lm-bridge-plugin/plugin/LMBridgePlugin.csproj")
          text = csproj_path.read_text()
          text, count1 = re.subn(r"<AssemblyVersion>[^<]+</AssemblyVersion>",
                                 f"<AssemblyVersion>{new_version}</AssemblyVersion>", text, count=1)
          text, count2 = re.subn(r"<Version>[^<]+</Version>",
                                 f"<Version>{new_version}</Version>", text, count=1)
          if count1 != 1 or count2 != 1:
            raise SystemExit("Failed to update LMBridgePlugin.csproj version fields.")
          csproj_path.write_text(text)

          readme_path = Path("deploy/README.md")
          if readme_path.exists():
            readme_text = readme_path.read_text()
            readme_text, count = re.subn(r"Deploy version: `[^`]+`",
                                         f"Deploy version: `{new_version}`", readme_text, count=1)
            if count == 1:
              readme_path.write_text(readme_text)

          print(new_version)
          PY

      - name: Commit and push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add VERSION deploy/VERSION deploy/README.md lm-bridge-plugin/plugin/LMBridgePlugin.csproj
          if git diff --cached --quiet; then
            echo "No version change to commit."
            exit 0
          fi
          NEW_VERSION=$(cat VERSION)
          git commit -m "Publish version ${NEW_VERSION}"
          git push
